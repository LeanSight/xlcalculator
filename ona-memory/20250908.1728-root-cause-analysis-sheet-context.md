# Diagnóstico Causa Raíz: Brecha de Contexto de Hoja

## Problema Identificado
```python
# En ast_nodes.py línea 59
current_sheet = 'Sheet1'  # Default fallback - PELIGROSO
```

## Análisis de Causa Raíz

### Flujo Actual Problemático

#### 1. **Evaluator.evaluate() llama a _get_context()**
```python
# evaluator.py línea 85
context = context if context is not None else self._get_context(addr)

def _get_context(self, ref):
    return EvaluatorContext(self, ref)  # ❌ No pasa contexto de hoja
```

#### 2. **EvaluatorContext.__init__() llama a super()**
```python
# evaluator.py línea 11
def __init__(self, evaluator, ref):
    super().__init__(evaluator.namespace, ref)  # ❌ Solo pasa namespace y ref
    self.evaluator = evaluator
```

#### 3. **EvalContext.__init__() no tiene contexto**
```python
# ast_nodes.py línea 50
def __init__(self, namespace=None, ref=None, seen=None):
    # ...
    if '!' in ref:
        current_sheet = ref.split('!')[0]  # ✅ Funciona para explícitos
    else:
        current_sheet = 'Sheet1'  # ❌ HARDCODED - Causa raíz
```

### Causa Raíz Identificada

**PÉRDIDA DE INFORMACIÓN DE CONTEXTO EN LA CADENA DE LLAMADAS**

```
Evaluator.evaluate(addr='D3')
    ↓ (pierde contexto de qué celda está evaluando)
_get_context(ref='D3') 
    ↓ (no sabe en qué hoja está la celda D3)
EvaluatorContext(evaluator, ref='D3')
    ↓ (no tiene información de hoja de origen)
EvalContext(namespace, ref='D3')
    ↓ (forzado a hardcodear Sheet1)
current_sheet = 'Sheet1'  # ❌ INCORRECTO
```

## Información Perdida

### ¿Qué información tiene el Evaluator?

```python
# En evaluator.py línea 69
def evaluate(self, addr, context=None):
    addr = self.resolve_names(addr)  # addr puede ser 'D3' o 'Sheet1!D3'
    cell = self.model.cells[addr]    # ✅ AQUÍ está la información!
    
    # cell.formula.sheet_name contiene la hoja correcta!
```

### Información Disponible pero No Utilizada

```python
# Cuando evaluamos 'D3':
cell = self.model.cells['D3']
formula_sheet = cell.formula.sheet_name  # 'Sheet1' - ✅ CORRECTO

# Pero esta información NO se pasa a EvalContext
```

## Comportamiento Correcto de Excel

### Regla de Excel
**"Una referencia implícita se resuelve en el contexto de la hoja donde está definida la fórmula"**

### Ejemplo Excel
```excel
' Celda Sheet2!D3 contiene: =SUM(A1:A10)
' Excel resuelve como: =SUM(Sheet2!A1:A10)
' NO como: =SUM(Sheet1!A1:A10)
```

### Información Necesaria
```python
# Para evaluar correctamente 'D3':
cell = model.cells['D3']
formula_sheet = cell.formula.sheet_name  # La hoja donde está la fórmula
# Usar formula_sheet como contexto para referencias implícitas
```

## Casos de Prueba para Validar

### Caso 1: **Celda en Sheet1 con referencia implícita**
```python
# Sheet1!D3 = "=SUM(A1:A10)"
# A1:A10 debe resolverse como Sheet1!A1:A10
```

### Caso 2: **Celda en Sheet2 con referencia implícita**
```python
# Sheet2!E5 = "=SUM(B1:B5)"  
# B1:B5 debe resolverse como Sheet2!B1:B5
```

### Caso 3: **Celda con referencias mixtas**
```python
# Sheet3!F1 = "=Sheet1!A1 + B1 + Sheet2!C1"
# B1 debe resolverse como Sheet3!B1 (contexto de la fórmula)
```

## Solución Arquitectural Requerida

### Modificar Cadena de Contexto

#### 1. **Evaluator debe extraer contexto de celda**
```python
def evaluate(self, addr, context=None):
    cell = self.model.cells[addr]
    formula_sheet = cell.formula.sheet_name if cell.formula else None
    
    context = context if context is not None else self._get_context(addr, formula_sheet)
```

#### 2. **_get_context debe recibir contexto**
```python
def _get_context(self, ref, formula_sheet=None):
    return EvaluatorContext(self, ref, formula_sheet)
```

#### 3. **EvaluatorContext debe propagar contexto**
```python
def __init__(self, evaluator, ref, formula_sheet=None):
    super().__init__(evaluator.namespace, ref, formula_sheet)
    self.evaluator = evaluator
```

#### 4. **EvalContext debe usar contexto correcto**
```python
def __init__(self, namespace=None, ref=None, seen=None, formula_sheet=None):
    if '!' in ref:
        current_sheet = ref.split('!')[0]  # Explícito
    else:
        current_sheet = formula_sheet or 'Sheet1'  # Contexto de fórmula
```

## Plan de Implementación ATDD

### 1. **Test de Aceptación que Falle**
```python
def test_implicit_reference_uses_formula_sheet_context():
    """Test that implicit references use the sheet where formula is defined."""
    # Crear modelo con celda en Sheet2 que tiene referencia implícita
    # Verificar que la referencia se resuelve en Sheet2, no Sheet1
```

### 2. **Implementación Mínima**
- Modificar cadena de contexto para propagar formula_sheet
- Usar formula_sheet en lugar de hardcoded 'Sheet1'

### 3. **Verificación**
- Test pasa
- Comportamiento consistente con Excel
- No regresiones en tests existentes

## Conclusión

**Causa Raíz**: Pérdida de información de contexto en la cadena de llamadas desde Evaluator hasta EvalContext.

**Solución**: Propagar `formula_sheet` desde la celda que contiene la fórmula hasta EvalContext para usar como contexto correcto para referencias implícitas.

**Resultado Esperado**: Comportamiento 100% consistente con Excel para resolución de contexto de hoja.