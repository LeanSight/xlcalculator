# Test Failure Analysis - Excel Behavior Diagnosis

## Failing Tests Analysis

### 1. ComplexCombinationsTest.test_3n
**Formula**: `=INDIRECT("Data!" & "A" & INDEX(Data!B1:B6, 2, 1))`
**Expected**: 'Alice'
**Actual**: 0

**Step-by-step analysis**:
1. `INDEX(Data!B1:B6, 2, 1)` should return `25` (value in Data!B2)
2. `"Data!" & "A" & 25` should return `"Data!A25"`
3. `INDIRECT("Data!A25")` should return the value in cell Data!A25

**Issue**: Data!A25 is empty, so INDIRECT should return 0 or empty value, not 'Alice'.

**Diagnosis**: **TEST EXPECTATION IS WRONG**. The test expects 'Alice' but the formula logically cannot return 'Alice' because:
- INDEX returns 25 (age of Alice)
- This creates reference "Data!A25" 
- Data!A25 is empty
- INDIRECT of empty cell returns 0

**Correct behavior**: The test should expect 0 or empty value, not 'Alice'.

### 2. ComplexCombinationsTest.test_type_consistency
**Issue**: Same as above - expects text but gets 0 (number)

**Diagnosis**: **TEST EXPECTATION IS WRONG** - follows from the previous issue.

### 3. DynamicArraysTest.test_5r
**Formula**: `=OFFSET(Data!A1, ROW(A1:A2)-1, 0)`
**Expected**: Array
**Actual**: 'Name' (single value)

**Analysis**:
- `ROW(A1:A2)` should return array `{1; 2}`
- `ROW(A1:A2)-1` should return array `{0; 1}`
- `OFFSET(Data!A1, {0; 1}, 0)` should return array with Data!A1 and Data!A2

**Issue**: OFFSET is not handling array inputs correctly - it's only returning the first result.

**Diagnosis**: **IMPLEMENTATION BUG** - OFFSET function needs to support array inputs according to Excel behavior.

### 4. FunctionsWithAggregationTest.test_4o
**Formula**: `=SUM(INDEX(Data!A1:E6, 0, 2))`
**Expected**: 130
**Actual**: 140

**Analysis**:
- `INDEX(Data!A1:E6, 0, 2)` should return entire column 2 (Age column)
- Values: Age, 25, 30, 35, 28, 22
- SUM should ignore text "Age" and sum numbers: 25+30+35+28+22 = 140

**Issue**: Test expects 130 but correct sum is 140.

**Diagnosis**: **TEST EXPECTATION IS WRONG** - the correct sum is 140, not 130.

## Summary

- **2 tests have wrong expectations** (complex_combinations)
- **1 test has wrong expectation** (functions_with_aggregation) 
- **1 test reveals implementation bug** (dynamic_arrays - OFFSET array support)

## Actions Required

1. **Fix test expectations** for wrong tests
2. **Fix OFFSET implementation** to support array inputs
3. **Verify INDEX function** is working correctly (currently returning Blank)