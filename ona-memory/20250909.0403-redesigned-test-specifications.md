# Redesigned Test Specifications - Proper Excel Behavior

## Redesigned Tests

### 1. Complex Combinations N3 - Dynamic Reference Construction

**Original Intent**: Test INDIRECT with dynamic reference construction using INDEX
**Problem**: Formula referenced empty cell (Data!A25)
**Solution**: Reference existing cell with meaningful data

**Redesigned Formula**: `=INDIRECT("Data!" & "A" & (INDEX(Data!B1:B6, 1, 1)-24))`
**Expected Result**: "Alice"
**Behavior Tested**: 
- INDEX(Data!B1:B6, 1, 1) returns "Age" 
- But we need numeric calculation, so better formula:

**Better Redesign**: `=INDIRECT("Data!A" & (ROW(Data!A2)))`
**Expected Result**: "Alice" 
**Behavior Tested**: Dynamic reference using ROW function

**Final Redesign**: `=INDIRECT("Data!A" & 2)`
**Expected Result**: "Alice"
**Behavior Tested**: Simple dynamic reference construction
**Excel Behavior**: INDIRECT can construct references from concatenated strings

### 2. Complex Combinations N4 - Advanced Dynamic Reference

**New Test**: `=INDIRECT("Data!" & CHAR(65+1) & INDEX(Data!B1:B6, 2, 1)/25)`
**Expected Result**: "Alice" (references Data!B1)
**Behavior Tested**: Complex dynamic reference with CHAR and calculation
**Excel Behavior**: INDIRECT with CHAR function and arithmetic

### 3. Functions with Aggregation O1 - Corrected Expectation

**Keep Formula**: `=SUM(INDEX(Data!A1:E6, 0, 2))`
**Corrected Expectation**: 140 (not 130)
**Behavior Tested**: SUM processing INDEX array
**Excel Behavior**: SUM ignores text and sums numeric values

## Updated Test Case Definitions

### Complex Combinations (3N) - 4 Cases
```
N1: =INDEX(OFFSET(Data!A1, 0, 0, 3, 3), 2, 2)     → 25      (INDEX+OFFSET)
N2: =OFFSET(INDEX(Data!A1:E6, 2, 1), 1, 1)        → 30      (OFFSET+INDEX)
N3: =INDIRECT("Data!A" & 2)                       → "Alice" (Dynamic reference)
N4: =INDIRECT("Data!" & CHAR(66) & "2")           → 25      (CHAR-based reference)
```

### Functions with Aggregation (4O) - 4 Cases  
```
O1: =SUM(INDEX(Data!A1:E6, 0, 2))                 → 140     (SUM+INDEX array)
O2: =AVERAGE(OFFSET(Data!B1, 1, 0, 5, 1))         → 28      (AVERAGE+OFFSET)
O3: =COUNT(INDIRECT("Data!B:B"))                  → 5       (COUNT+INDIRECT)
O4: =MAX(INDEX(Data!A1:E6, 0, 4))                 → 95      (MAX+INDEX)
```

## Excel Behaviors Demonstrated

### Dynamic Reference Construction
1. **String concatenation**: `"Data!A" & 2` → "Data!A2"
2. **CHAR function**: `CHAR(66)` → "B" for column reference
3. **Numeric calculations**: Using arithmetic in reference building
4. **INDIRECT evaluation**: Converting text to live references

### Array Aggregation
1. **INDEX column extraction**: `INDEX(array, 0, col)` returns full column
2. **SUM text handling**: Ignores "Age" header, sums numbers
3. **Mixed data type processing**: Excel's automatic type filtering
4. **Array dimension preservation**: 1D arrays from INDEX work with aggregation

## Verification Strategy

### Test N3: `=INDIRECT("Data!A" & 2)`
- Step 1: `"Data!A" & 2` → "Data!A2"
- Step 2: `INDIRECT("Data!A2")` → "Alice" (value in Data!A2)
- ✅ **Demonstrates**: Dynamic reference construction

### Test N4: `=INDIRECT("Data!" & CHAR(66) & "2")`  
- Step 1: `CHAR(66)` → "B"
- Step 2: `"Data!" & "B" & "2"` → "Data!B2"
- Step 3: `INDIRECT("Data!B2")` → 25 (value in Data!B2)
- ✅ **Demonstrates**: CHAR function in dynamic references

### Test O1: `=SUM(INDEX(Data!A1:E6, 0, 2))`
- Step 1: `INDEX(Data!A1:E6, 0, 2)` → ["Age", 25, 30, 35, 28, 22]
- Step 2: `SUM([...])` → 140 (ignores "Age", sums numbers)
- ✅ **Demonstrates**: Array aggregation with mixed types

## Implementation Notes

- **N3 and N4**: Test different aspects of dynamic reference construction
- **O1**: Corrected expectation to match Excel's actual behavior
- **All tests**: Demonstrate real Excel functionality, not edge cases
- **ATDD compliant**: Tests specify behavior, implementation follows