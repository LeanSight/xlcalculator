# Criterios de Desarrollo ATDD - Resumen de Directrices

## Principio Fundamental: ATDD Estricto

### Regla Central
**NO implementar código hasta que haya un test de aceptación que falle y indique exactamente qué necesita ser implementado.**

### Ciclo ATDD Obligatorio
1. **Test de Aceptación que Falle** - Debe existir un test de alto nivel que demuestre la funcionalidad requerida
2. **Identificar Caso Específico** - Determinar exactamente qué caso específico está fallando
3. **Implementación Mínima** - Escribir solo el código mínimo necesario para pasar ese test específico
4. **Refactorizar** - Solo si es necesario para mantener calidad del código
5. **Repetir** - Continuar con el siguiente caso de falla

## Tests de Aceptación

### Definición
- Los tests que usan el nuevo XLSX de dynamic ranges son considerados **tests de aceptación**
- Estos tests en estado RED indican dónde construir lógica
- Son la única fuente autorizada para guiar la implementación

### Prohibiciones Estrictas
- ❌ **NO crear tests de unidad** antes de tener tests de aceptación fallando
- ❌ **NO implementar código** sin un test de aceptación específico que falle
- ❌ **NO escribir implementaciones completas** que pasen cualquier test mientras no haya un error de test de integración superior
- ❌ **NO anticipar funcionalidad** que no esté siendo demandada por un test de aceptación

## Metodología de Implementación

### Estado RED Requerido
- Debe existir un test de aceptación fallando antes de cualquier implementación
- El test debe indicar específicamente qué funcionalidad falta
- Solo implementar para resolver ese error específico

### Implementación Mínima
- Escribir solo el código necesario para pasar el test específico que está fallando
- No agregar funcionalidad adicional "por si acaso"
- No implementar casos que no estén siendo probados actualmente

### Progresión Controlada
- Un test de aceptación a la vez
- Un caso específico a la vez
- Implementación incremental guiada por fallos

## Limpieza y Eliminación

### Código Previo
- Eliminar todo código de implementación de dynamic range creado previamente
- Eliminar tests de unidad que no sean tests de aceptación
- Mantener solo la infraestructura mínima requerida por el sistema

### Archivos de Soporte
- Mantener solo los archivos que son tests de aceptación o infraestructura necesaria
- Eliminar implementaciones especulativas o "preparatorias"

## Estructura de Tests de Aceptación

### Archivo Principal
- `DYNAMIC_RANGES_COMPREHENSIVE.xlsx` - Contiene los casos de prueba reales
- `dynamic_ranges_comprehensive_test.py` - Ejecuta los tests de aceptación

### Flujo de Trabajo
1. Ejecutar test de aceptación
2. Identificar primer caso que falla
3. Implementar mínimo código para ese caso
4. Verificar que el test pasa
5. Refactorizar solo si es necesario
6. Repetir con siguiente caso

## Principios de Calidad

### Fidelidad a Excel
- La implementación debe comportarse exactamente como Excel
- Mismos valores de retorno
- Mismos tipos de error
- Misma semántica de evaluación

### Simplicidad
- Código mínimo viable
- Sin sobre-ingeniería
- Sin abstracciones prematuras
- Solo la complejidad que demanden los tests

## Documentación del Proceso

### Registro de Decisiones
- Documentar qué test de aceptación está guiando cada implementación
- Registrar el caso específico que se está resolviendo
- Mantener trazabilidad entre test y código

### Estado del Desarrollo
- Siempre saber qué test está fallando actualmente
- Mantener visibilidad del progreso a través de tests de aceptación
- No avanzar sin confirmación de que el test actual pasa

### Ubicación de Documentos
- **Todos los documentos de análisis y decisiones van en `ona-memory/`**
- **Formato de nombrado**: `YYYYMMDD.HHMM-descripcion-breve.md`
- **Ejemplos**: 
  - `20250907.0030-atdd-implementation-analysis.md`
  - `20250907.0045-test-failure-specific-case.md`
  - `20250907.0100-refactoring-decision-log.md`

## Resumen Ejecutivo

**ATDD Estricto significa:**
- Tests de aceptación primero, siempre
- Implementación mínima guiada por fallos específicos
- No código especulativo o anticipatorio
- Progresión controlada caso por caso
- Fidelidad absoluta a los comportamientos demostrados por tests de aceptación

**El objetivo es:** Implementación robusta, confiable y exactamente alineada con los requisitos demostrados por tests de aceptación reales.

---

## Criterios Adicionales de ona-memory

### Especificaciones de Excel (20250905.0021)

#### Funciones Dinámicas Core
- **OFFSET**: `OFFSET(reference, rows, cols, [height], [width])` - Retorna referencia offset
- **INDEX**: `INDEX(array, row_num, [col_num])` - Retorna valor en intersección
- **INDIRECT**: `INDIRECT(ref_text, [a1])` - Retorna referencia desde texto

#### Sintaxis Especial
- Soporte para `:OFFSET(...)` y `:INDEX(...)` - Excel permite prefijo de dos puntos
- Parámetros opcionales con comportamiento específico (height/width en OFFSET)

### Manejo de Errores (20250905.0055)

#### Tipos de Error Excel
```python
#REF!    - RefExcelError      - Errores de referencia (fuera de límites)
#VALUE!  - ValueExcelError    - Errores de valor (tipo incorrecto)
#NAME?   - NameExcelError     - Errores de nombre (referencia inválida)
```

#### Mapeo de Errores por Función
- **OFFSET**: `#REF!` para coordenadas fuera de límites, `#VALUE!` para parámetros inválidos
- **INDEX**: `#REF!` para índices fuera de array, `#VALUE!` para array vacío
- **INDIRECT**: `#NAME?` para referencias malformadas, `#VALUE!` para texto vacío

#### Capas de Validación
- **Capa 1**: Validación automática de tipos con `@xl.validate_args`
- **Capa 2**: Validación de lógica de negocio específica
- **Capa 3**: Manejo de errores de Excel nativos

### Filosofía de Generación Excel (20250906.2330)

#### Principio Core
**Generar archivos Excel correctos, punto.**

#### Prohibiciones Estrictas
- ❌ **NO acomodar tests** - La generación no debe considerar qué esperan los tests
- ❌ **NO valores fallback** - Si una fórmula falla, la generación debe FALLAR
- ❌ **NO compromisos por tests** - No cambiar fórmulas porque los tests podrían fallar

#### Comportamiento Correcto
- ✅ **Generar comportamiento Excel auténtico** - Fórmulas y valores exactos
- ✅ **Fallar rápido en problemas** - STOP y reportar si Excel no puede manejar una fórmula
- ✅ **Reporte claro de errores** - Información específica sobre fallos de generación

### Criterios de Selección de Soluciones (20250905.2006)

#### Criterios Primarios
1. **Limpieza**: Cambios mínimos y enfocados que abordan el problema core
2. **Auto-documentación**: Código que expresa claramente la intención
3. **Bajo riesgo**: Cambios que minimizan la posibilidad de introducir nuevos bugs
4. **Impacto inmediato**: Soluciones que arreglan directamente los problemas identificados
5. **Mantenibilidad**: Código fácil de entender y modificar

#### Ejemplo de Aplicación
- Preferir `is not None` sobre validaciones complejas
- Cambios de una palabra cuando sea posible
- Seguir mejores prácticas de Python
- Minimizar superficie de cambio

### Plan de Refactorización (20250905.1536)

#### Patrones de Duplicación Identificados
1. **Lógica de conversión de parámetros** - Centralizar en función utilitaria
2. **Patrones de manejo de errores** - Decorador común para try/except
3. **Validación de arrays** - Función común para extracción de datos

#### Enfoque de Refactorización
- Solo después de estado GREEN
- Eliminar duplicación sin cambiar comportamiento
- Mantener tests pasando durante refactorización
- Funciones utilitarias centralizadas

### Implementación de Correcciones (20250906.0022)

#### Causa Raíz de Fallos
- Archivos Excel sin valores calculados almacenados
- Generadores que sobrescriben fórmulas con valores estáticos
- openpyxl no calcula fórmulas automáticamente

#### Soluciones Preferidas
1. **Remover sobrescrituras de valores** - Solo asignar fórmulas, dejar que Excel calcule
2. **Forzar cálculo si disponible** - Usar métodos de cálculo de openpyxl si existen
3. **Validación de archivos generados** - Verificar que contienen tanto fórmulas como valores

**El objetivo expandido es:** Implementación que sigue ATDD estricto, mantiene fidelidad absoluta a Excel, usa criterios de calidad establecidos, y genera archivos Excel auténticos sin compromisos.