# Análisis: Comportamiento Documentado de Excel para Default Sheet

## Pregunta Crítica
¿Cuál es el comportamiento documentado de Excel cuando no se especifica hoja en una referencia?

## Línea Problemática Identificada
```python
# En ast_nodes.py línea 56
current_sheet = 'Sheet1'  # Default fallback
```

**¿Por qué es peligroso?** Asume que siempre existe 'Sheet1' y que es el contexto correcto.

## Investigación: Comportamiento Oficial de Excel

### Documentación Microsoft Excel

#### 1. **Contexto de Hoja Actual (Active Sheet)**
```excel
' Si estoy en la hoja "Ventas" y escribo:
=A1 + B1

' Excel interpreta esto como:
=Ventas!A1 + Ventas!B1
' NO como Sheet1!A1 + Sheet1!B1
```

#### 2. **Referencias Relativas vs Absolutas**
```excel
' En hoja "Datos":
=SUM(A1:A10)        -> SUM(Datos!A1:A10)
=SUM(Sheet1!A1:A10) -> SUM(Sheet1!A1:A10)  ' Explícito
```

#### 3. **Comportamiento en Fórmulas**
```excel
' En hoja "Análisis", esta fórmula:
=IF(A1>0, B1*2, Sheet1!C1)

' Se resuelve como:
=IF(Análisis!A1>0, Análisis!B1*2, Sheet1!C1)
'     ^^^^^^^^      ^^^^^^^^      ^^^^^^^^
'     Implícito     Implícito     Explícito
```

## Casos Problemáticos en xlcalculator

### Caso 1: **Workbook sin Sheet1**
```python
# ¿Qué pasa si el workbook tiene hojas: "Ventas", "Compras", "Análisis"?
# Pero NO tiene "Sheet1"

current_sheet = 'Sheet1'  # ❌ CRASH - Sheet1 no existe
```

### Caso 2: **Evaluación en Contexto Incorrecto**
```python
# Evaluando fórmula en hoja "Datos"
# Fórmula: =SUM(A1:A10)
# Debería resolverse como: SUM(Datos!A1:A10)

current_sheet = 'Sheet1'  # ❌ INCORRECTO - resuelve como Sheet1!A1:A10
```

### Caso 3: **Referencias Cruzadas**
```python
# En hoja "Resumen":
# Fórmula: =Ventas!A1 + B1 + Compras!C1
# B1 debería ser Resumen!B1

current_sheet = 'Sheet1'  # ❌ INCORRECTO - B1 se resuelve como Sheet1!B1
```

## Comportamiento Correcto Según Excel

### Regla Fundamental
**"Una referencia sin hoja se resuelve en el contexto de la hoja donde se está evaluando la fórmula"**

### Implementación Correcta Necesaria

#### 1. **Contexto de Evaluación**
```python
# En lugar de:
current_sheet = 'Sheet1'  # ❌ Hardcoded

# Debería ser:
current_sheet = context.current_sheet  # ✅ Del contexto de evaluación
```

#### 2. **Propagación de Contexto**
```python
# El evaluador debe pasar el contexto correcto
class EvaluatorContext:
    def __init__(self, evaluator, ref, current_sheet=None):
        self.current_sheet = current_sheet or self._extract_sheet_from_ref(ref)
```

#### 3. **Extracción de Contexto**
```python
def _extract_sheet_from_ref(self, ref):
    """Extract current sheet from reference context."""
    if '!' in ref:
        return ref.split('!')[0]
    else:
        # ❌ PROBLEMA: ¿Cómo saber la hoja actual?
        raise ValueError("Cannot determine current sheet context")
```

## Análisis del Problema en xlcalculator

### Problema Arquitectural
```python
# En ast_nodes.py - EvalContext.__init__
def __init__(self, namespace=None, ref=None, seen=None):
    # ...
    if '!' in ref:
        current_sheet = ref.split('!')[0]  # ✅ Correcto para explícitos
    else:
        current_sheet = 'Sheet1'  # ❌ INCORRECTO para implícitos
```

**El problema**: No hay información sobre la hoja actual cuando `ref` no tiene `!`.

### Casos Reales en xlcalculator

#### Caso A: **Evaluando 'D3'**
```python
# En test_crossrefs.py
evaluator.evaluate('D3')

# Flujo actual:
# 1. EvalContext.__init__(ref='D3')
# 2. '!' not in 'D3' -> current_sheet = 'Sheet1'  # ❌ ¿Por qué Sheet1?
# 3. CellReference.parse('D3', current_sheet='Sheet1')
```

#### Caso B: **Evaluando 'Sheet2!A1'**
```python
# Flujo actual:
# 1. EvalContext.__init__(ref='Sheet2!A1')  
# 2. '!' in 'Sheet2!A1' -> current_sheet = 'Sheet2'  # ✅ Correcto
# 3. CellReference.parse('Sheet2!A1', current_sheet='Sheet2')
```

## Soluciones Posibles

### Opción 1: **Contexto desde Evaluador**
```python
class EvaluatorContext:
    def __init__(self, evaluator, ref, evaluation_sheet=None):
        self.evaluation_sheet = evaluation_sheet
        # Usar evaluation_sheet como contexto para referencias implícitas
```

### Opción 2: **Contexto desde Celda**
```python
# Usar la hoja de la celda que contiene la fórmula
cell = model.cells[addr]
formula_sheet = cell.formula.sheet_name
# Usar formula_sheet como contexto
```

### Opción 3: **Contexto Explícito**
```python
# Requerir contexto explícito en todas las evaluaciones
evaluator.evaluate('D3', current_sheet='Sheet2')
```

## Recomendación

### Solución Inmediata
```python
# En ast_nodes.py
def __init__(self, namespace=None, ref=None, seen=None):
    # ...
    if '!' in ref:
        current_sheet = ref.split('!')[0]
    else:
        # ⚠️ TEMPORAL: Usar Sheet1 pero documentar el problema
        current_sheet = 'Sheet1'  # TODO: Needs proper context propagation
        # Log warning about missing context
        import warnings
        warnings.warn(f"Using Sheet1 as default context for '{ref}'. "
                     "This may not reflect actual Excel behavior.")
```

### Solución Arquitectural
1. **Modificar EvaluatorContext** para recibir contexto de hoja
2. **Modificar Evaluator.evaluate()** para pasar contexto correcto
3. **Extraer contexto de la celda** que contiene la fórmula

## Conclusión

**La línea es efectivamente peligrosa** porque:

1. **Viola semántica Excel**: Referencias implícitas deben usar hoja actual, no Sheet1
2. **Asume existencia**: Sheet1 puede no existir en el workbook
3. **Contexto incorrecto**: Puede resolver referencias en hoja equivocada
4. **Comportamiento impredecible**: Resultados diferentes a Excel real

**Acción requerida**: Implementar propagación correcta de contexto de hoja desde el evaluador hacia las referencias implícitas.